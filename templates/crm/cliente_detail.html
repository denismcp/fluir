{% extends "base.html" %}
{% load humanize %}

{% block title %}Hub do Cliente | {{ cliente.razao_social }}{% endblock %}

{% block content %}
<style>
    /* DESIGN SYSTEM ULTRA PREMIUM */
    .nav-tabs-premium { border-bottom: 2px solid #e9ecef; background: #fff; border-radius: 15px 15px 0 0; }
    .nav-tabs-premium .nav-link { border: none; color: #525f7f !important; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; padding: 1.2rem 1.5rem; opacity: 0.7; transition: 0.3s ease; }
    .nav-tabs-premium .nav-link:hover { color: #5e72e4 !important; opacity: 1; background: rgba(94, 114, 228, 0.08); transform: translateY(-2px); }
    .nav-tabs-premium .nav-link.active { color: #5e72e4 !important; background: transparent; border-bottom: 3px solid #5e72e4; opacity: 1; }
    .kpi-card { border: none; border-left: 4px solid; border-radius: 12px; transition: 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .label-premium { font-size: 0.7rem; font-weight: 800; color: #adb5bd; text-transform: uppercase; display: block; margin-bottom: 2px; }
    .comm-icon { font-size: 1.1rem; transition: 0.2s; margin-right: 8px; }
    .comm-enabled { opacity: 1; cursor: pointer; }
    .comm-disabled { opacity: 0.2; filter: grayscale(1); cursor: not-allowed; }

    /* ESTILO PREMIUM SOFT PARA LINKS DE NEGÓCIO */
    .link-premium-soft {
        color: #32325d;
        text-decoration: none !important;
        font-weight: 700;
        transition: all 0.2s ease-in-out;
        display: inline-block;
    }
    .link-premium-soft:hover {
        color: #5e72e4;
        transform: translateX(4px);
    }

    /* BADGES DE PRAZO */
    .badge-atraso { background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
    .badge-no-prazo { background-color: #f0fdf4; color: #16a34a; border: 1px solid #86efac; }
</style>

<div class="container-fluid py-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800 font-weight-bold"><i class="fas fa-building text-primary mr-2"></i>{{ cliente.razao_social }}</h1>
            <span class="badge badge-pill badge-light border text-muted mt-1">CNPJ/CPF: {{ cliente.cnpj_cpf|default:"-" }}</span>
        </div>
        <div class="d-flex">
            <button class="btn btn-primary shadow-sm px-4 mr-2 font-weight-bold rounded-pill" 
                    hx-get="{% url 'crm:oportunidade_create' %}?cliente_id={{ cliente.pk }}" 
                    hx-target="#htmx-modal-content" 
                    data-toggle="modal" 
                    data-target="#htmx-modal">
                <i class="fas fa-plus mr-2"></i>Nova Oportunidade
            </button>

            <button class="btn btn-warning shadow-sm px-4 mr-2 font-weight-bold" hx-get="{% url 'crm:cliente_update' cliente.pk %}" hx-target="#htmx-modal-content" data-toggle="modal" data-target="#htmx-modal">Editar Cadastro</button>
            <button class="btn btn-outline-secondary shadow-sm px-4" onclick="window.history.back()">Voltar</button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card kpi-card border-primary h-100 py-2"><div class="card-body"><span class="label-premium text-primary">Vendas (Geral)</span><div class="h5 mb-0 font-weight-bold text-gray-800">R$ {{ total_vendas_geral|default:"0,00"|intcomma }}</div></div></div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card kpi-card border-success h-100 py-2"><div class="card-body"><span class="label-premium text-success">Vendas no Ano</span><div class="h5 mb-0 font-weight-bold text-gray-800">R$ {{ total_vendas_ano|default:"0,00"|intcomma }}</div></div></div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card kpi-card border-info h-100 py-2"><div class="card-body"><span class="label-premium text-info">Últimos 90 dias</span><div class="h5 mb-0 font-weight-bold text-gray-800">R$ {{ total_vendas_trimestre|default:"0,00"|intcomma }}</div></div></div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card kpi-card border-warning h-100 py-2"><div class="card-body"><span class="label-premium text-warning">Últimos 30 dias</span><div class="h5 mb-0 font-weight-bold text-gray-800">R$ {{ total_vendas_mes|default:"0,00"|intcomma }}</div></div></div>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-lg overflow-hidden">
        <div class="card-header bg-white p-0">
            <ul class="nav nav-tabs nav-tabs-premium px-4" id="clienteTab" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#cadastro">Dados Cadastrais</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#contatos_aba">Contatos</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#atividades">Timeline (FUP)</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#oport">Oportunidades</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#contratos">Contratos</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#propostas">Propostas</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#geo">Localização</a></li>
            </ul>
        </div>
        
        <div class="card-body p-4">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="cadastro">
                    <div class="row">
                        <div class="col-md-4">
                            <span class="label-premium">Razão Social</span><div class="h6 font-weight-bold">{{ cliente.razao_social }}</div>
                            <span class="label-premium mt-3">Nome Fantasia</span><div class="h6">{{ cliente.nome_fantasia|default:"-" }}</div>
                            <span class="label-premium mt-3">Regime Tributário</span><div class="h6">{{ cliente.get_regime_tributario_display|default:"-" }}</div>
                        </div>
                        <div class="col-md-4 border-left">
                            <span class="label-premium">E-mail Corporativo</span><div class="h6">{{ cliente.email_corporativo|default:"-" }}</div>
                            <span class="label-premium mt-3">Telefone Empresa</span><div class="h6">{{ cliente.telefone_principal|default:"-" }}</div>
                        </div>
                        <div class="col-md-4 border-left">
                            <span class="label-premium">Endereço Completo</span><div class="h6">{{ cliente.endereco|default:"-" }}</div>
                            <span class="label-premium mt-3">Cidade / UF</span><div class="h6">{{ cliente.cidade|default:"-" }} / {{ cliente.estado|default:"-" }}</div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="contatos_aba">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="m-0 font-weight-bold text-dark">Pessoas de Contato</h5>
                        <button class="btn btn-primary btn-sm rounded-pill px-4 shadow-sm" hx-get="{% url 'crm:contato_create' cliente.pk %}" hx-target="#htmx-modal-content" data-toggle="modal" data-target="#htmx-modal">Adicionar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-items-center">
                            <thead class="bg-light small text-muted text-uppercase">
                                <tr><th>Contato</th><th>Canais Diretos</th><th>Papel / Depto</th><th class="text-center">Ações</th></tr>
                            </thead>
                            <tbody>
                                {% for contato in cliente.contato_set.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if contato.e_principal %}<i class="fas fa-star text-warning mr-2" title="Principal"></i>{% endif %}
                                            <div>
                                                <a href="javascript:void(0)" class="text-dark font-weight-bold" hx-get="{% url 'crm:contato_update' contato.pk %}" hx-target="#htmx-modal-content" data-toggle="modal" data-target="#htmx-modal">{{ contato.primeiro_nome }} {{ contato.sobrenome }}</a><br>
                                                <small class="text-muted">{{ contato.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <a href="mailto:{{ contato.email }}" class="comm-icon comm-enabled text-primary" title="Outlook"><i class="fas fa-envelope"></i></a>
                                            <a href="https://teams.microsoft.com/l/chat/0/0?users={{ contato.email }}" target="_blank" class="comm-icon comm-enabled text-info" title="Teams"><i class="fab fa-microsoft"></i></a>
                                            {% if contato.celular and contato.e_whatsapp %}
                                                <a href="https://wa.me/55{{ contato.celular|safe }}" target="_blank" class="comm-icon comm-enabled text-success" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                                            {% else %}
                                                <i class="fab fa-whatsapp comm-icon comm-disabled" title="WhatsApp não habilitado"></i>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td><span class="badge badge-soft-info">{{ contato.get_papel_na_decisao_display }}</span><br><small class="text-muted">{{ contato.departamento|default:"Geral" }}</small></td>
                                    <td class="text-center"><button class="btn btn-sm btn-outline-warning border-0" hx-get="{% url 'crm:contato_update' contato.pk %}" hx-target="#htmx-modal-content" data-toggle="modal" data-target="#htmx-modal"><i class="fas fa-edit"></i></button></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="atividades">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="font-weight-bold text-dark">Timeline de Interações (Follow-up)</h5>
                        {% with prim_oport=oportunidades.first %}
                            {% if prim_oport %}
                                <button class="btn btn-primary btn-sm rounded-pill px-4 shadow-sm" hx-get="{% url 'crm:atividade_create' prim_oport.pk %}?cliente_id={{ cliente.pk }}" hx-target="#htmx-modal-content" data-toggle="modal" data-target="#htmx-modal">Registrar Interação</button>
                            {% else %}
                                <small class="text-muted"><i class="fas fa-info-circle mr-1"></i> Crie uma oportunidade para registrar interações.</small>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="bg-light small text-muted text-uppercase">
                                <tr>
                                    <th>Data / Hora</th>
                                    <th>Tipo</th>
                                    <th>Assunto / Detalhes</th>
                                    <th>Responsável</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Situação</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for atividade in cliente.atividade_set.all %}
                                <tr>
                                    <td><span class="text-dark font-weight-bold">{{ atividade.data_hora|date:"d/m/Y H:i" }}</span></td>
                                    <td><span class="badge badge-pill badge-light border text-uppercase" style="font-size: 0.65rem;">{{ atividade.get_tipo_atividade_display }}</span></td>
                                    <td style="max-width: 300px;">
                                        <div class="font-weight-bold text-dark">{{ atividade.assunto }}</div>
                                        <small class="text-muted text-truncate d-block">{{ atividade.descricao|default:"Sem descrição adicional." }}</small>
                                    </td>
                                    <td><small class="text-primary font-weight-bold">{{ atividade.responsavel.get_full_name|default:atividade.responsavel.username }}</small></td>
                                    <td class="text-center">
                                        {% if atividade.concluida %}
                                            <span class="badge badge-success-soft px-3 py-2 rounded-pill"><i class="fas fa-check-circle mr-1"></i> Concluída</span>
                                        {% else %}
                                            <span class="badge badge-warning-soft px-3 py-2 rounded-pill"><i class="fas fa-clock mr-1"></i> Aberta</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if not atividade.concluida %}
                                            {% now "Y-m-d H:i" as current_time %}
                                            {% if atividade.data_hora|date:"Y-m-d H:i" < current_time %}
                                                <span class="badge badge-atraso px-2 py-1 rounded-pill small font-weight-bold">EM ATRASO</span>
                                            {% else %}
                                                <span class="badge badge-no-prazo px-2 py-1 rounded-pill small font-weight-bold">NO PRAZO</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted small">---</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary border-0" 
                                                title="Editar Interação"
                                                hx-get="{% url 'crm:atividade_update' atividade.pk %}" 
                                                hx-target="#htmx-modal-content" 
                                                data-toggle="modal" 
                                                data-target="#htmx-modal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted small">Nenhuma interação registrada para este cliente.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="oport">
                    <table class="table table-hover align-items-center">
                        <thead class="bg-light small text-muted text-uppercase"><tr><th>Previsão</th><th>Negócio</th><th>Etapa</th><th>Valor Estimado</th></tr></thead>
                        <tbody>
                            {% for op in oportunidades %}
                            <tr>
                                <td>{{ op.data_fechamento_prevista|date:"d/m/Y"|default:"-" }}</td>
                                <td>
                                    <a href="{% url 'crm:oportunidade_detail' op.pk %}" class="link-premium-soft">
                                        {{ op.nome }}
                                    </a>
                                </td>
                                <td><span class="badge badge-pill badge-info px-3">{{ op.etapa.nome }}</span></td>
                                <td class="font-weight-bold text-success">R$ {{ op.valor_estimado|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="contratos">
                    <table class="table table-hover">
                        <thead class="bg-light small text-muted text-uppercase"><tr><th>Contrato</th><th>Status Operacional</th><th>Valor Recorrente</th></tr></thead>
                        <tbody>
                            {% for op in oportunidades %}{% if op.tipo_oportunidade == 'contrato' %}
                            <tr><td><a href="{% url 'crm:oportunidade_detail' op.pk %}" class="link-premium-soft">{{ op.nome }}</a></td><td><span class="badge badge-pill badge-primary px-3">{{ op.get_status_operacional_display }}</span></td><td class="font-weight-bold text-primary">R$ {{ op.valor_estimado|intcomma }}</td></tr>
                            {% endif %}{% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="propostas">
                    <table class="table table-hover">
                        <thead class="bg-light small text-muted text-uppercase"><tr><th>ID</th><th>Status</th><th>Total</th></tr></thead>
                        <tbody>{% for p in propostas %}<tr><td><a href="{% url 'crm:proposta_itens' p.pk %}" class="link-premium-soft">#{{ p.id_proposta }}</a></td><td><span class="badge badge-pill badge-warning">{{ p.get_status_display }}</span></td><td class="font-weight-bold text-success">R$ {{ p.valor_total|intcomma }}</td></tr>{% endfor %}</tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="geo">
                    <div class="rounded-lg overflow-hidden border shadow-inner" style="height: 500px;">
                        {% if cliente.endereco and cliente.cidade %}
                        <iframe width="100%" height="100%" frameborder="0" style="border:0" 
                                src="https://maps.google.com/maps?q={{ cliente.endereco|urlencode }},{{ cliente.cidade|urlencode }},{{ cliente.estado }}&output=embed" allowfullscreen>
                        </iframe>
                        {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted small">
                            Cadastre o logradouro e cidade para análise geográfica.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        var activeTab = sessionStorage.getItem('activeTabCliente');
        if (activeTab) { $('.nav-tabs-premium a[href="' + activeTab + '"]').tab('show'); }
        $('.nav-tabs-premium a').on('shown.bs.tab', function (e) { sessionStorage.setItem('activeTabCliente', $(e.target).attr('href')); });
        document.body.addEventListener('htmx:afterOnLoad', function(evt) { if(evt.detail.xhr.status === 204) { location.reload(); } });
    });
</script>
{% endblock %}