{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Pipeline de Vendas | Kanban Premium{% endblock %}

{% block extra_css %}
<style>
    /* 1. Cores e Variáveis de Design Fluir */
    :root {
        --kanban-bg: #f4f7fa;
        --column-header-text: #32325d;
        --card-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        --primary-gradient: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
    }

    body { background-color: var(--kanban-bg); }

    /* 2. Container e Colunas com Gradientes */
    .kanban-container { 
        display: flex; 
        overflow-x: auto; 
        padding-bottom: 30px; 
        min-height: 75vh;
        gap: 1.5rem;
    }

    .kanban-column {
        flex: 0 0 310px;
        background: rgba(235, 237, 242, 0.6);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        border: 1px solid rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
    }

    /* 3. Header das Colunas Realçado */
    .column-header { 
        padding: 20px 20px 15px; 
        background: white;
        border-radius: 20px 20px 0 0;
        border-bottom: 2px solid #e9ecef;
    }

    .column-title { 
        font-size: 0.85rem; 
        font-weight: 800; 
        color: var(--column-header-text); 
        text-transform: uppercase; 
        letter-spacing: 1.2px;
        margin: 0; 
    }

    .column-sum { 
        font-size: 1rem; 
        font-weight: 700; 
        color: #2dce89; 
        display: block; 
        margin-top: 6px;
        filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.05));
    }

    .count-badge {
        background: #f4f7fa;
        color: #5e72e4;
        font-weight: 800;
        border-radius: 8px;
        padding: 5px 10px;
        font-size: 0.75rem;
    }

    /* 4. Cards Premium */
    .kanban-card-list { padding: 15px; flex-grow: 1; overflow-y: auto; }

    .opportunity-card {
        cursor: pointer;
        transition: all 0.25s cubic-bezier(.25,.8,.25,1);
        border: none;
        border-radius: 12px;
        margin-bottom: 1.2rem;
        background: #ffffff;
        box-shadow: var(--card-shadow);
        border-left: 5px solid #5e72e4;
    }

    .opportunity-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07) !important;
    }

    .card-client-tag {
        font-size: 0.65rem;
        font-weight: 800;
        color: #8898aa;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    /* 5. Barra de Busca Estilo Premium */
    .search-input { 
        padding-left: 45px; 
        border-radius: 30px; 
        border: 1px solid #e9ecef; 
        height: 45px;
        background: white;
        font-weight: 600;
    }
    .search-input:focus { border-color: #5e72e4; box-shadow: 0 0 15px rgba(94, 114, 228, 0.1); }

    .sortable-ghost { opacity: 0.1; transform: scale(0.9); }
    .sortable-drag { background: #fff !important; box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important; }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4 px-2">
        <div>
            <h1 class="h3 mb-1 text-gray-800 font-weight-bold">Pipeline de Vendas</h1>
            <p class="text-muted small">Gerencie suas oportunidades comerciais no sistema Fluir</p>
        </div>
        
        <div class="d-flex align-items-center gap-3">
            <div class="search-container">
                <i class="fas fa-search" style="position: absolute; left: 18px; top: 15px; z-index: 5; color: #adb5bd;"></i>
                <input type="text" id="kanban-search" class="form-control search-input shadow-none" 
                       placeholder="Buscar por cliente ou negócio...">
            </div>
            <button class="btn btn-primary rounded-pill px-4 shadow-sm ml-3 font-weight-bold"
                    style="background: var(--primary-gradient); border: none; height: 45px;"
                    hx-get="{% url 'crm:oportunidade_create' %}" hx-target="#htmx-modal-content" data-toggle="modal" data-target="#htmx-modal">
                <i class="fas fa-plus mr-2"></i>Novo Negócio
            </button>
        </div>
    </div>

    <div class="kanban-container px-2">
        {% for etapa in etapas %}
        <div class="kanban-column">
            <div class="column-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="column-title">{{ etapa.nome }}</h6>
                        <span class="column-sum" data-etapa-id="{{ etapa.id }}">
                            R$ 0,00
                        </span>
                    </div>
                    <span class="count-badge" id="badge-{{ etapa.id }}">
                        ({{ etapa.oportunidades_lista.count }})
                    </span>
                </div>
            </div>
            
            <div class="kanban-card-list" id="etapa-{{ etapa.id }}" data-etapa-id="{{ etapa.id }}">
                {% for op in etapa.oportunidades_lista %}
                <div class="card opportunity-card shadow-sm" 
                     data-id="{{ op.id }}" 
                     data-search="{{ op.nome }} {{ op.cliente.razao_social }} {{ op.cliente.nome_fantasia }}"
                     data-value="{{ op.valor_estimado|stringformat:'.2f' }}"
                     onclick="location.href='{% url 'crm:oportunidade_detail' op.pk %}'">
                    <div class="card-body p-3">
                        <div class="card-client-tag text-uppercase">
                            {{ op.cliente.nome_fantasia|default:op.cliente.razao_social|truncatechars:30 }}
                        </div>
                        <div class="h6 font-weight-bold text-dark mb-3" style="min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ op.nome }}
                        </div>
                        <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                            <span class="text-success font-weight-bold" style="font-size: 0.95rem;">R$ {{ op.valor_estimado|intcomma }}</span>
                            <div class="badge badge-light text-muted font-weight-bold" style="font-size: 0.7rem; border-radius: 6px;">
                                <i class="far fa-calendar-alt mr-1"></i>{{ op.data_fechamento_prevista|date:"d/m" }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    function formatMoney(value) {
        return "R$ " + value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function updateColumnTotals() {
        document.querySelectorAll('.kanban-column').forEach(function(column) {
            const list = column.querySelector('.kanban-card-list');
            const cards = list.querySelectorAll('.opportunity-card:not([style*="display: none"])');
            const sumDisplay = column.querySelector('.column-sum');
            const countBadge = column.querySelector('.count-badge');

            let total = 0;
            cards.forEach(card => {
                total += parseFloat(card.getAttribute('data-value').replace(',', '.'));
            });

            if (sumDisplay) sumDisplay.innerText = formatMoney(total);
            if (countBadge) countBadge.innerText = "(" + cards.length + ")";
        });
    }

    // Busca reativa
    document.getElementById('kanban-search').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.opportunity-card').forEach(card => {
            const content = card.getAttribute('data-search').toLowerCase();
            card.style.display = content.includes(term) ? 'block' : 'none';
        });
        updateColumnTotals();
    });

    // Lógica SortableJS mantida e integrada
    document.querySelectorAll('.kanban-card-list').forEach(function (el) {
        new Sortable(el, {
            group: 'kanban',
            animation: 250,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function (evt) {
                updateColumnTotals();
                
                const opportunityId = evt.item.getAttribute('data-id');
                const newEtapaId = evt.to.getAttribute('data-etapa-id');
                const header = evt.to.closest('.kanban-column').querySelector('.column-title');
                const nomeEtapa = header ? header.innerText.toUpperCase() : "";

                if (nomeEtapa.includes("GANHO") || nomeEtapa.includes("FECHAMENTO")) {
                    console.log("Fluxo de fechamento ativado para ID:", opportunityId);
                    let urlFechamento = "{% url 'crm:oportunidade_fechamento' 0 %}".replace('0', opportunityId);
                    
                    htmx.ajax('GET', urlFechamento, {
                        target: '#htmx-modal-content',
                        swap: 'innerHTML'
                    });
                } else if (evt.from !== evt.to) {
                    htmx.ajax('POST', "{% url 'crm:atualizar_etapa' %}", {
                        values: {
                            'opportunity_id': opportunityId,
                            'new_etapa_id': newEtapaId
                        }
                    });
                }
            }
        });
    });

    document.addEventListener('DOMContentLoaded', updateColumnTotals);
</script>
{% endblock %}