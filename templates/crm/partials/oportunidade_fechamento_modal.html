{% load crispy_forms_tags %}
{% load humanize %}

<div class="modal-header bg-success text-white">
    <h5 class="modal-title"><i class="fas fa-check-circle mr-2"></i>Concluir Negócio: {{ oportunidade.nome }}</h5>
    <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
</div>

<form hx-post="{% url 'crm:oportunidade_concluir' oportunidade.pk %}" hx-target="#htmx-modal-content">
    {% csrf_token %}
    <div class="modal-body">
        <p class="text-muted">Parabéns pela venda! Para finalizar, selecione qual das propostas abaixo foi a escolhida pelo cliente <strong>{{ oportunidade.cliente.razao_social }}</strong>:</p>
        
        <div class="list-group shadow-sm mb-3">
            {% for proposta in propostas %}
            <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <input class="form-check-input mr-3" type="radio" name="proposta_vencedora" value="{{ proposta.pk }}" required>
                    <div>
                        <strong class="text-primary">{{ proposta.id_proposta }}</strong><br>
                        <small class="text-muted">Criada em: {{ proposta.data_criacao|date:"d/m/Y" }}</small>
                    </div>
                </div>
                <span class="badge badge-success badge-pill p-2">R$ {{ proposta.valor_total|floatformat:2|intcomma }}</span>
            </label>
            {% empty %}
            <div class="alert alert-warning mb-0">Nenhuma proposta encontrada. Você precisa ter ao menos uma proposta para ganhar a oportunidade.</div>
            {% endfor %}
        </div>

        <div class="form-group mt-3">
            <label class="small font-weight-bold">Observações de Fechamento (Opcional):</label>
            <textarea name="obs_fechamento" class="form-control" rows="2" placeholder="Ex: Cliente fechou após desconto no item X..."></textarea>
        </div>
    </div>
    <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success shadow-sm" {% if not propostas %}disabled{% endif %}>
            <i class="fas fa-troféu mr-1"></i> Confirmar Venda
        </button>
    </div>
</form>