<!DOCTYPE html>
{% load static %}
{% load humanize %}
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 1.2cm; }
        body { font-family: 'Helvetica', 'Arial', sans-serif; color: #333; line-height: 1.5; font-size: 10pt; margin: 0; }
        .text-navy { color: #0d2d5e; }
        .header-table { width: 100%; border-bottom: 2px solid #0d2d5e; margin-bottom: 20px; }
        .logo { height: 60px; padding-bottom: 10px; }
        .proposal-title { text-align: right; vertical-align: bottom; padding-bottom: 10px; }
        .section-header { border-left: 5px solid #ffc107; padding-left: 10px; margin: 20px 0 10px 0; font-weight: bold; text-transform: uppercase; font-size: 11pt; }
        
        /* Tabela de Investimento */
        .invest-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #0d2d5e; }
        .invest-table thead th { 
            background-color: #0d2d5e; color: #ffffff; padding: 12px 10px; 
            text-align: left; font-size: 9pt; border-bottom: 3px solid #ffc107; text-transform: uppercase;
        }
        .invest-table td { border: 1px solid #eee; padding: 10px; font-size: 9pt; vertical-align: top; }
        .invest-table tbody tr:nth-child(even) { background-color: #f8faff; }

        /* Alinhamento Profissional de Totais */
        .value-line { 
            text-align: right; 
            padding: 8px 12px; 
            font-size: 9pt; 
            border: 1px solid #eee;
            border-top: none;
            color: #555; 
            background: #fff;
        }
        .discount-text { color: #dc3545 !important; }
        .total-box { 
            background-color: #0d2d5e; 
            color: white; 
            font-weight: bold; 
            font-size: 12pt; 
            text-align: right; 
            padding: 12px; 
            margin-top: -1px; 
        }
        
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .info-table td { border: 1px solid #eee; padding: 8px; width: 50%; vertical-align: top; }
        .label { font-weight: bold; color: #555; font-size: 8pt; text-transform: uppercase; display: block; }
        .conditions-box { background-color: #fcfcfc; border: 1px solid #eee; padding: 15px; margin-top: 20px; font-size: 9pt; border-left: 4px solid #0d2d5e; }
        .tax-disclaimer { font-size: 7.5pt; color: #777; text-align: justify; margin-top: 15px; line-height: 1.2; }
        .sig-container { margin-top: 3cm; width: 100%; text-align: center; }
        .sig-line { border-top: 1px solid #333; width: 60%; margin: 0 auto 5px auto; }
    </style>
</head>
<body>

    <table class="header-table">
        <tr>
            <td><img src="{% static 'img/logo.png' %}" class="logo"></td>
            <td class="proposal-title">
                <h2 class="text-navy" style="margin:0">PROPOSTA COMERCIAL</h2>
                <strong style="font-size: 12pt;">Nº {{ proposal.id_proposta }}</strong><br>
                <span>Data: {{ proposal.data_criacao|date:"d/m/Y" }}</span>
            </td>
        </tr>
    </table>

    <div class="section-header text-navy">Identificação das Partes</div>
    <table class="info-table">
        <tr>
            <td>
                <span class="label">Contratante (Cliente)</span>
                <strong>{{ opportunity.cliente.razao_social }}</strong><br>
                {% if opportunity.contato_principal %}
                    A/C: {{ opportunity.contato_principal.primeiro_nome }} {{ opportunity.contato_principal.sobrenome }}
                {% endif %}
            </td>
            <td>
                <span class="label">Contratada (Fornecedor)</span>
                <strong>GRUPO TC DO BRASIL</strong><br>
                E-mail: {{ user.email|default:"comercial@tcdobrasil.com.br" }}
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <span class="label">Objeto da Proposta</span>
                <strong>{{ opportunity.nome }}</strong>
            </td>
        </tr>
    </table>

    <div class="section-header text-navy">Detalhamento do Investimento</div>

    {# CONTEÚDO DA DESCRIÇÃO COMERCIAL ADICIONADO AQUI #}
    {% if proposal.descricao_comercial %}
    <div style="text-align: justify; font-size: 11pt; margin-bottom: 20px; color: #444;">
        {{ proposal.descricao_comercial|linebreaks }}
    </div>
    {% endif %}

    <table class="invest-table" style="margin-bottom: 0;">
        <thead>
            <tr>
                <th>Descrição do Produto ou Serviço</th>
                <th style="text-align: center; width: 60px;">Qtde</th>
                <th style="text-align: right; width: 100px;">Unit. (R$)</th>
                <th style="text-align: right; width: 120px;">Total (R$)</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>
                    <strong>
                        {% if item.resumo_item %}{{ item.resumo_item }}
                        {% elif item.produto %}{{ item.produto.nome }}
                        {% elif item.servico %}{{ item.servico.nome }}
                        {% else %}Item de Proposta{% endif %}
                    </strong>
                    {% if item.especificacao_tecnica %}<br><small style="color: #666;">{{ item.especificacao_tecnica }}</small>{% endif %}
                </td>
                <td style="text-align: center;">{{ item.quantidade }}</td>
                <td style="text-align: right;">{{ item.preco_unitario|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">{{ item.total|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if proposal.valor_frete > 0 %}
    <div class="value-line">
        <span style="margin-right: 15px;">(+) VALOR DO FRETE:</span>
        <strong style="display: inline-block; width: 120px;">R$ {{ proposal.valor_frete|floatformat:2|intcomma }}</strong>
    </div>
    {% endif %}

    {% if proposal.valor_desconto > 0 %}
    <div class="value-line discount-text">
        <span style="margin-right: 15px;">(-) DESCONTO CONCEDIDO:</span>
        <strong style="display: inline-block; width: 120px;">R$ {{ proposal.valor_desconto|floatformat:2|intcomma }}</strong>
    </div>
    {% endif %}

    <div class="total-box">
        <span style="margin-right: 15px;">VALOR TOTAL DA PROPOSTA:</span>
        <span style="display: inline-block; width: 120px;">R$ {{ proposal.valor_total|floatformat:2|intcomma }}</span>
    </div>

    <div class="conditions-box">
        <strong class="text-navy">CONDIÇÕES:</strong><br>
        • Prazo de Entrega: <strong>{{ proposal.prazo_entrega|default:"A combinar" }}</strong><br>
        • Validade da Proposta: <strong>{{ proposal.validade_dias|default:"05" }} dias</strong><br>
        • Forma de Pagamento: <strong>{{ proposal.forma_pagamento|default:"Conforme contrato" }}</strong>
    </div>

    <div class="tax-disclaimer">
        Os valores apresentados contemplam os impostos vigentes. Eventuais alterações tributárias após esta data poderão ensejar renegociação.
    </div>

    <div class="sig-container">
        <div class="sig-line"></div>
        <strong>ACEITE DO CLIENTE</strong><br>
        <small>Nome do Responsável / CPF / Data</small>
    </div>

</body>
</html>