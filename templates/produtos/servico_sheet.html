{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-concierge-bell mr-2 text-primary"></i>Gestão de Serviços (Planilha)
        </h1>
        
        <div class="btn-group shadow-sm">
            <a href="{% url 'produtos:servico_import' %}" class="btn btn-sm btn-info border">
                <i class="fas fa-upload mr-1"></i> Importar CSV
            </a>
            <a href="?export=xlsx" class="btn btn-sm btn-primary border">
                <i class="fas fa-download mr-1"></i> Exportar
            </a>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm table-hover mb-0" id="sheetTable">
                    <thead class="bg-gray-100">
                        <tr>
                            <th width="120">Código</th>
                            <th>Descrição do Serviço (Mão de Obra)</th>
                            <th width="150" class="text-right">Preço de Venda</th>
                            <th width="100" class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in servicos %}
                        <tr data-id="{{ s.id }}">
                            <td class="bg-light font-weight-bold text-center">{{ s.codigo_interno }}</td>
                            <td contenteditable="true" class="editable-cell" data-field="nome">{{ s.nome }}</td>
                            <td contenteditable="true" class="editable-cell text-right text-primary font-weight-bold" data-field="preco_venda_padrao">
                                {{ s.preco_venda_padrao|floatformat:2 }}
                            </td>
                            <td class="text-center">
                                <span class="badge {% if s.ativo %}badge-success{% else %}badge-danger{% endif %}">
                                    {% if s.ativo %}Ativo{% else %}Inativo{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .editable-cell:focus { background-color: #fff9c4; outline: 2px solid #4e73df; }
    .save-success { background-color: #c8e6c9 !important; transition: background 0.5s; }
</style>

<script>
    // Lógica de salvamento automático via Ajax (idêntica ao produto_sheet)
    document.querySelectorAll('.editable-cell').forEach(cell => {
        cell.addEventListener('blur', function() {
            const id = this.closest('tr').dataset.id;
            const field = this.dataset.field;
            const newValue = this.innerText.trim();

            const formData = new FormData();
            formData.append('id', id);
            formData.append('campo', field);
            formData.append('valor', newValue);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch("{% url 'produtos:update_cell' %}", {
                method: 'POST',
                body: formData
            }).then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.classList.add('save-success');
                    setTimeout(() => this.classList.remove('save-success'), 1000);
                }
            });
        });
    });
</script>
{% endblock %}